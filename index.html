<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>B·∫£n ƒë·ªì ki·ªÉm so√°t hi·ªáu su·∫•t FTTH GPON</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }
#container { display: flex; height: 100vh; }
#map { flex: 3; }
#side { flex: 2; padding: 10px; overflow-y: auto; border-left: 1px solid #ccc; }

h3 { margin-top: 10px; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th, td { border: 1px solid #ccc; padding: 4px; text-align: left; }
th { background: #eee; }

.legend div { margin-bottom: 4px; }
.legend span {
  display: inline-block;
  width: 14px;
  height: 14px;
  margin-right: 6px;
  vertical-align: middle;
}

.highlight {
  animation: blink 1s infinite;
}

@keyframes blink {
  0% { opacity: 0.4; }
  50% { opacity: 1; }
  100% { opacity: 0.4; }
}
</style>
</head>

<body>
<div id="container">
  <div id="map"></div>

  <div id="side">
    <h3>üîé Nh·∫≠p v·ªã tr√≠ t√¨m ki·∫øm</h3>
    <input id="searchInput" style="width:100%" placeholder="ƒê·ªãa ch·ªâ ho·∫∑c lat,long" />
    <button onclick="searchLocation()">T√¨m ki·∫øm</button>

    <h3>üéØ L·ªçc theo hi·ªáu su·∫•t</h3>
    <select id="filter" onchange="applyFilter()">
      <option value="all">T·∫•t c·∫£</option>
      <option value="lt20">< 20%</option>
      <option value="20_50">20‚Äì50%</option>
      <option value="50_80">50‚Äì80%</option>
      <option value="80_100">80‚Äì<100%</option>
      <option value="gte100">‚â•100%</option>
    </select>

    <h3>‚öôÔ∏è ∆Øu ti√™n n√¢ng c·∫•p (K·ªπ thu·∫≠t)</h3>

    <b>∆Øu ti√™n 1 (‚â•100%)</b>
    <table id="p1"><tr><th>T·∫≠p ƒëi·ªÉm</th><th>Hi·ªáu su·∫•t</th></tr></table>

    <br/>
    <b>∆Øu ti√™n 2 (80‚Äì<100%)</b>
    <table id="p2"><tr><th>T·∫≠p ƒëi·ªÉm</th><th>Hi·ªáu su·∫•t</th></tr></table>
  </div>
</div>

<script>
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq/gviz/tq?tqx=out:csv&sheet=Danh%20s√°ch%20t·∫≠p%20ƒëi·ªÉm%20S2";

const map = L.map('map').setView([10.8, 106.7], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let circles = [];
let allData = [];

function colorByUsage(u) {
  if (u < 0.2) return 'blue';
  if (u < 0.5) return 'green';
  if (u < 0.8) return 'yellow';
  if (u < 1) return 'red';
  return 'black';
}

fetch(SHEET_URL)
.then(r => r.text())
.then(csv => {
  const rows = csv.split('\n').slice(1);
  rows.forEach(r => {
    const c = r.split(',');
    if (!c[9] || !c[10]) return;

    const usage = parseFloat(c[7]);
    const obj = {
      name: c[2],
      addr: c[8],
      max: c[3],
      used: c[4],
      left: c[5],
      usage,
      lat: parseFloat(c[9]),
      lng: parseFloat(c[10])
    };
    allData.push(obj);

    const circle = L.circle([obj.lat, obj.lng], {
      radius: 300,
      color: colorByUsage(usage),
      fillColor: colorByUsage(usage),
      fillOpacity: 0.4
    })
    .bindPopup(`
<b>${obj.name}</b><br/>
${obj.addr}<br/>
Port t·ªëi ƒëa: ${obj.max}<br/>
ƒê√£ d√πng: ${obj.used}<br/>
C√≤n l·∫°i: ${obj.left}<br/>
Hi·ªáu su·∫•t: ${(usage*100).toFixed(1)}%
`);
    circle.addTo(map);
    circle.data = obj;
    circles.push(circle);
  });

  const group = L.featureGroup(circles);
  map.fitBounds(group.getBounds());

  buildTables();
});

function applyFilter() {
  const f = document.getElementById('filter').value;
  circles.forEach(c => {
    const u = c.data.usage;
    let show = true;
    if (f === 'lt20') show = u < 0.2;
    if (f === '20_50') show = u >=0.2 && u <0.5;
    if (f === '50_80') show = u >=0.5 && u <0.8;
    if (f === '80_100') show = u >=0.8 && u <1;
    if (f === 'gte100') show = u >=1;
    show ? c.addTo(map) : map.removeLayer(c);
  });
}

function buildTables() {
  allData.forEach(d => {
    const row = `<tr><td>${d.name}</td><td>${(d.usage*100).toFixed(1)}%</td></tr>`;
    if (d.usage >= 1) document.getElementById('p1').innerHTML += row;
    else if (d.usage >= 0.8) document.getElementById('p2').innerHTML += row;
  });
}

function distance(a,b,c,d){
  return map.distance([a,b],[c,d]);
}

function searchLocation() {
  const v = document.getElementById('searchInput').value.trim();
  let latlng;

  if (v.includes(',')) {
    const p = v.split(',');
    latlng = [parseFloat(p[0]), parseFloat(p[1])];
    processSearch(latlng);
  } else {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${v}`)
    .then(r=>r.json())
    .then(j=>{
      if (!j[0]) return alert("Kh√¥ng t√¨m th·∫•y");
      latlng = [parseFloat(j[0].lat), parseFloat(j[0].lon)];
      processSearch(latlng);
    });
  }
}

function processSearch(latlng) {
  map.setView(latlng, 15);
  L.marker(latlng).addTo(map).bindPopup("üìç V·ªã tr√≠ kh√°ch h√†ng").openPopup();

  circles.forEach(c => c.setStyle({weight:1}));
  const nearest = circles
    .map(c => ({c, d: distance(latlng[0],latlng[1],c.data.lat,c.data.lng)}))
    .sort((a,b)=>a.d-b.d)
    .slice(0,3);

  nearest.forEach(n => {
    n.c.setStyle({weight:4});
    n.c.getElement().classList.add("highlight");
    n.c.bindPopup(
      `${n.c.data.name}<br/>
Kho·∫£ng c√°ch: ${n.d.toFixed(0)} m<br/>
${n.c.data.left > 0 ? "‚úÖ C√≥ th·ªÉ b√°n" : "‚ùå Full port"}`
    );
  });
}
</script>
</body>
</html>
