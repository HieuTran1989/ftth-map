<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>B·∫£n ƒë·ªì hi·ªáu su·∫•t FTTH GPON</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { margin:0; font-family: Arial; }
#map { height: 100vh; }

.control {
    position: absolute;
    top: 10px;
    left: 10px;
    background: white;
    padding: 10px;
    z-index: 1000;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    width: 260px;
}

.legend div { margin-bottom: 4px; }
.legend span {
    display: inline-block;
    width: 14px;
    height: 14px;
    margin-right: 6px;
}

.highlight {
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
}
</style>
</head>

<body>

<div class="control">
    <b>Hi·ªáu su·∫•t s·ª≠ d·ª•ng</b><br>
    <select id="filter">
        <option value="all">T·∫•t c·∫£</option>
        <option value="blue"><20%</option>
        <option value="green">20‚Äì50%</option>
        <option value="yellow">50‚Äì80%</option>
        <option value="red">80‚Äì100%</option>
        <option value="black">>=100%</option>
    </select>

    <hr>
    <b>Nh·∫≠p v·ªã tr√≠ t√¨m ki·∫øm</b><br>
    <input id="search" placeholder="ƒê·ªãa ch·ªâ ho·∫∑c lat,long" style="width:100%">
    <button onclick="searchLocation()">T√¨m</button>

    <hr>
    <button onclick="exportUpgrade()">üì§ Xu·∫•t DS c·∫ßn n√¢ng c·∫•p</button>

    <hr>
    <div class="legend">
        <div><span style="background:blue"></span><20%</div>
        <div><span style="background:green"></span>20‚Äì50%</div>
        <div><span style="background:yellow"></span>50‚Äì80%</div>
        <div><span style="background:red"></span>80‚Äì100%</div>
        <div><span style="background:black"></span>>=100%</div>
    </div>
</div>

<div id="map"></div>

<script>
const map = L.map('map').setView([16,108], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const circles = [];
const allData = [];
const lines = [];

function getColor(p) {
    if (p >= 1) return "black";
    if (p >= 0.8) return "red";
    if (p >= 0.5) return "yellow";
    if (p >= 0.2) return "green";
    return "blue";
}

// Load Google Sheet
fetch("https://docs.google.com/spreadsheets/d/1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq/gviz/tq?sheet=Danh s√°ch t·∫≠p ƒëi·ªÉm S2")
.then(res => res.text())
.then(text => {
    const json = JSON.parse(text.substr(47).slice(0,-2));
    json.table.rows.forEach(r => {
        const lat = r.c[9]?.v;
        const lng = r.c[10]?.v;
        if (!lat || !lng) return;

        const obj = {
            name: r.c[2]?.v,
            max: r.c[3]?.v,
            used: r.c[4]?.v,
            free: r.c[5]?.v,
            perf: r.c[7]?.v,
            lat, lng
        };
        allData.push(obj);

        const circle = L.circle([lat,lng], {
            radius: 300,
            color: getColor(obj.perf),
            fillColor: getColor(obj.perf),
            fillOpacity: 0.5
        }).bindPopup(`
            <b>${obj.name}</b><br>
            T·ªça ƒë·ªô: ${lat}, ${lng}<br>
            T·ªïng port: ${obj.max}<br>
            ƒê√£ d√πng: ${obj.used}<br>
            C√≤n l·∫°i: ${obj.free}<br>
            Hi·ªáu su·∫•t: ${(obj.perf*100).toFixed(1)}%
        `).addTo(map);

        circle.meta = obj;
        circles.push(circle);
    });

    const group = L.featureGroup(circles);
    map.fitBounds(group.getBounds());
});

// Filter
document.getElementById("filter").onchange = function() {
    circles.forEach(c => {
        const color = getColor(c.meta.perf);
        if (this.value === "all" || color === this.value) {
            c.addTo(map);
        } else {
            map.removeLayer(c);
        }
    });
};

function distance(a,b){
    return map.distance(a,b);
}

function searchLocation(){
    lines.forEach(l => map.removeLayer(l));
    lines.length = 0;

    const q = document.getElementById("search").value;
    if (q.includes(",")) {
        const [lat,lng] = q.split(",").map(Number);
        handleSearch(lat,lng);
    } else {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`)
        .then(r=>r.json())
        .then(d=>{
            if(d.length) handleSearch(+d[0].lat,+d[0].lon);
        });
    }
}

function handleSearch(lat,lng){
    const point = L.marker([lat,lng]).addTo(map);
    map.setView([lat,lng],16);

    const candidates = allData
        .filter(d=>d.free>0)
        .map(d=>({...d,dist:distance([lat,lng],[d.lat,d.lng])}))
        .sort((a,b)=>a.dist-b.dist)
        .slice(0,3);

    candidates.forEach(d=>{
        const line = L.polyline([[lat,lng],[d.lat,d.lng]],{
            color:'blue', dashArray:'5,5'
        }).addTo(map);
        lines.push(line);
    });
}

function exportUpgrade(){
    const data = allData.filter(d=>d.perf>=0.8).map(d=>({
        "T√™n t·∫≠p ƒëi·ªÉm": d.name,
        "Lat": d.lat,
        "Long": d.lng,
        "Hi·ªáu su·∫•t": d.perf,
        "∆Øu ti√™n": d.perf>=1 ? 1 : 2
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "N√¢ng c·∫•p");
    XLSX.writeFile(wb, "tap_diem_can_nang_cap.xlsx");
}
</script>
</body>
</html>
