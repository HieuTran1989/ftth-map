<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Bản đồ hiệu suất FTTH GPON</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }

    .panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,.3);
      width: 300px;
    }

    .panel h3 { margin: 0 0 8px; font-size: 16px; }

    .legend div {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .color-box {
      width: 14px;
      height: 14px;
      margin-right: 6px;
    }

    button {
      margin-top: 6px;
      width: 100%;
      padding: 6px;
      cursor: pointer;
    }

    input, select {
      width: 100%;
      padding: 6px;
      margin-bottom: 6px;
    }

    .blink {
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
  </style>
</head>

<body>
<div id="map"></div>

<div class="panel">
  <h3>FTTH – Hiệu suất tập điểm</h3>

  <input id="searchInput" placeholder="Nhập vị trí tìm kiếm (địa chỉ hoặc Lat,Long)" />
  <button onclick="searchLocation()">Tìm kiếm</button>

  <select id="filterSelect" onchange="applyFilter()">
    <option value="all">Hiển thị tất cả</option>
    <option value="blue">< 20%</option>
    <option value="green">20% – <50%</option>
    <option value="yellow">50% – <80%</option>
    <option value="red">80% – <100%</option>
    <option value="black">>= 100%</option>
  </select>

  <button onclick="exportUpgradeExcel()">Xuất DS cần nâng cấp</button>

  <div class="legend">
    <div><span class="color-box" style="background:#3498db"></span>< 20%</div>
    <div><span class="color-box" style="background:#2ecc71"></span>20–50%</div>
    <div><span class="color-box" style="background:#f1c40f"></span>50–80%</div>
    <div><span class="color-box" style="background:#e74c3c"></span>80–100%</div>
    <div><span class="color-box" style="background:#000"></span>>=100%</div>
  </div>
</div>

<script>
const map = L.map("map").setView([16, 108], 6);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

const SHEET_CSV =
  "https://docs.google.com/spreadsheets/d/1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq/gviz/tq?tqx=out:csv&sheet=Danh%20s%C3%A1ch%20t%E1%BA%ADp%20%C4%91i%E1%BB%83m%20S2";

let circles = [];
let allPoints = [];

function getColor(rate) {
  if (rate < 0.2) return "blue";
  if (rate < 0.5) return "green";
  if (rate < 0.8) return "yellow";
  if (rate < 1) return "red";
  return "black";
}

fetch(SHEET_CSV)
  .then(res => res.text())
  .then(csv => {
    const rows = csv.split("\n").slice(1);
    rows.forEach(r => {
      const c = r.split(",");
      const lat = parseFloat(c[9]);
      const lng = parseFloat(c[10]);
      if (isNaN(lat) || isNaN(lng)) return;

      const rate = parseFloat(c[7]);
      const color = getColor(rate);

      const circle = L.circle([lat, lng], {
        radius: 300,
        color,
        fillColor: color,
        fillOpacity: 0.5
      }).addTo(map);

      circle.bindPopup(`
        <b>${c[2]}</b><br>
        Lat: ${lat}, Lng: ${lng}<br>
        Dung lượng: ${c[3]}<br>
        Đã dùng: ${c[4]}<br>
        Còn lại: ${c[5]}<br>
        Hiệu suất: ${(rate * 100).toFixed(1)}%
      `);

      circles.push({ circle, color, rate, lat, lng, name: c[2], free: parseInt(c[5]) });
      allPoints.push([lat, lng]);
    });

    map.fitBounds(allPoints);
  });

function applyFilter() {
  const f = document.getElementById("filterSelect").value;
  circles.forEach(o => {
    if (f === "all" || o.color === f) {
      map.addLayer(o.circle);
    } else {
      map.removeLayer(o.circle);
    }
  });
}

function searchLocation() {
  const q = document.getElementById("searchInput").value.trim();
  if (!q) return;

  if (q.includes(",")) {
    const [lat, lng] = q.split(",").map(Number);
    focusLocation(lat, lng);
  } else {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`)
      .then(r => r.json())
      .then(d => {
        if (d.length > 0) focusLocation(+d[0].lat, +d[0].lon);
      });
  }
}

function focusLocation(lat, lng) {
  map.setView([lat, lng], 15);
  const customer = L.marker([lat, lng]).addTo(map);

  const near = circles
    .filter(c => c.free > 0)
    .map(c => ({
      ...c,
      dist: map.distance([lat, lng], [c.lat, c.lng])
    }))
    .sort((a, b) => a.dist - b.dist || a.rate - b.rate)
    .slice(0, 3);

  near.forEach(c => {
    c.circle.setStyle({ weight: 4 });
    c.circle.getElement().classList.add("blink");
    c.circle.bindTooltip(`${Math.round(c.dist)} m`).openTooltip();
  });
}

function exportUpgradeExcel() {
  let csv = "Tên tập điểm,Lat,Long,Hiệu suất,Ưu tiên\n";
  circles.forEach(c => {
    if (c.rate >= 0.8) {
      const p = c.rate >= 1 ? "Ưu tiên 1" : "Ưu tiên 2";
      csv += `${c.name},${c.lat},${c.lng},${(c.rate*100).toFixed(1)}%,${p}\n`;
    }
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "tap_diem_can_nang_cap.csv";
  link.click();
}
</script>
</body>
</html>
